<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  
  <!-- VIEWPORT ÚNICA E OTIMIZADA PARA PWA MOBILE -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <!-- MANIFEST E TEMA -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#8e44ad" />
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">

  <!-- PWA META TAGS OTIMIZADAS -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Viza Iluminação">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <!-- TILES E CORES WINDOWS -->
  <meta name="msapplication-TileImage" content="/images/icon-512x512.png">
  <meta name="msapplication-TileColor" content="#8e44ad">

  <!-- APPLE TOUCH ICONS -->
  <link rel="apple-touch-icon" href="/images/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/images/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/images/icon-512x512.png">

  <!-- Bibliotecas -->
  <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <!-- TITULO DA GUIA -->
  <title>Sistema De Iluminação Viza Atacadista</title>

  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
      min-height: 100vh;
    }
    
    /* Espaço para menu inferior apenas em mobile */
    @media (max-width: 767px) {
      body {
        padding-bottom: 80px;
      }
    }

    /* ========== SISTEMA DE NOTIFICAÇÕES TOAST ========== */
    
    /* Container das notificações */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
      pointer-events: none;
    }

    /* Estilo base do toast */
    .toast {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      max-width: 350px;
      min-width: 320px;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: auto;
      position: relative;
      overflow: hidden;
    }

    /* Toast visível */
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }

    /* Toast saindo */
    .toast.hide {
      transform: translateX(100%);
      opacity: 0;
      margin-bottom: -80px;
    }

    /* Ícones dos toasts */
    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    /* Conteúdo do toast */
    .toast-content {
      flex: 1;
      min-width: 0;
    }

    .toast-title {
      font-weight: 600;
      font-size: 14px;
      margin: 0 0 4px 0;
      color: #2c3e50;
      line-height: 1.3;
    }

    .toast-message {
      font-size: 13px;
      color: #64748b;
      margin: 0;
      line-height: 1.4;
    }

    /* Botão de fechar */
    .toast-close {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .toast-close:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #64748b;
    }

    /* Barra de progresso */
    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: currentColor;
      border-radius: 0 0 12px 12px;
      opacity: 0.3;
      transition: width linear;
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }
    .toast.success .toast-icon { color: #10b981; }
    .toast.success .toast-progress { background: #10b981; }

    .toast.error {
      border-left: 4px solid #ef4444;
    }
    .toast.error .toast-icon { color: #ef4444; }
    .toast.error .toast-progress { background: #ef4444; }

    .toast.warning {
      border-left: 4px solid #f59e0b;
    }
    .toast.warning .toast-icon { color: #f59e0b; }
    .toast.warning .toast-progress { background: #f59e0b; }

    .toast.info {
      border-left: 4px solid #3b82f6;
    }
    .toast.info .toast-icon { color: #3b82f6; }
    .toast.info .toast-progress { background: #3b82f6; }

    .toast.system {
      border-left: 4px solid #8b5cf6;
    }
    .toast.system .toast-icon { color: #8b5cf6; }
    .toast.system .toast-progress { background: #8b5cf6; }

    /* ========== MENU INFERIOR ESTILO APP ========== */
    
    /* ========== NAVEGAÇÃO NO CABEÇALHO ========== */
    .bottom-nav {
      display: none; /* Oculto por padrão no desktop */
    }
    
    @media (max-width: 767px) {
      .bottom-nav {
        display: block; /* Mostrar apenas no mobile */
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        padding: 8px 0;
        z-index: 1000;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        margin-top: 0;
      }
    }
    
    .nav-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px 8px;
      text-decoration: none;
      color: #666;
      border-radius: 12px;
      transition: all 0.3s ease;
      min-width: 60px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .nav-item.active {
      color: #8e44ad;
      background: rgba(142, 68, 173, 0.1);
    }
    
    .nav-item:hover {
      color: #8e44ad;
      background: rgba(142, 68, 173, 0.05);
    }
    
    .nav-icon {
      font-size: 20px;
      margin-bottom: 2px;
      line-height: 1;
    }
    
    .nav-label {
      font-size: 10px;
      font-weight: 500;
      text-align: center;
      line-height: 1.2;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      padding: 15px 20px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      position: sticky;
      top: 0;
      z-index: 999;
      gap: 20px;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 0 0 auto;
    }
    
    .header-center {
      flex: 0 0 auto;
      text-align: left;
      margin-left: 40px;
    }
    
    .header-title-section {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 2px;
    }
    
    .header-title {
      font-size: 18px;
      font-weight: 700;
      color: #2c3e50;
      margin: 0;
      line-height: 1.2;
    }
    
    .header-subtitle {
      font-size: 12px;
      color: #6c757d;
      margin: 0;
      font-weight: 500;
      text-align: left;
      margin-left: 0;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex: 1;
      gap: 25px;
    }
    
    .header-nav-section {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 1;
      justify-content: center;
    }
    
    .header-logo-right {
      flex: 0 0 auto;
    }

    .logo {
      height: 40px;
      object-fit: contain;
    }
    
    nav a {
      margin: 0 8px;
      text-decoration: none;
      color: #333;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: inline-block;
      font-size: 14px;
    }
    
    nav a:hover {
      background: rgba(142,68,173,0.1);
      color: #8e44ad;
    }

    /* Status da conexão no header */
    .status-conexao {
      font-size: 11px;
      font-weight: 700;
      transition: all 0.3s ease;
      white-space: nowrap;
      padding: 4px 8px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .status-online {
      color: #10b981;
    }
    
    .status-offline {
      color: #ef4444;
    }
    
    .status-connecting {
      color: #fbbf24;
    }
    
    main {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.18);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    
    .card h2 {
      margin: 0 0 20px 0;
      color: #2c3e50;
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      position: relative;
    }
    
    .card h2:after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 3px;
      background: linear-gradient(90deg, #8B5CF6, #7C3AED);
      border-radius: 2px;
    }
    
    /* Tarifa Config */
    .tarifa-config {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border: 2px solid rgba(195, 54, 54, 0.1);
    }
    
    .tarifa-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .tarifa-group label {
      font-size: 16px;
      font-weight: 600;
      color: #495057;
    }
    
    .tarifa-input-group {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .currency-symbol {
      background: #7C3AED;
      color: white;
      padding: 10px 12px;
      border-radius: 8px 0 0 8px;
      font-weight: 600;
      font-size: 16px;
    }
    
    .tarifa-input {
      flex: 1;
      max-width: 150px;
      padding: 10px 15px;
      border: 2px solid #e9ecef;
      border-left: none;
      border-radius: 0 8px 8px 0;
      font-size: 16px;
      font-weight: 500;
      background: white;
      transition: all 0.3s ease;
    }
    
    .tarifa-input:focus {
      border-color: #c33636;
      outline: none;
      box-shadow: 0 0 0 3px rgba(195,54,54,0.1);
    }
    
    .btn-save-tarifa {
      padding: 10px 20px;
      background: linear-gradient(135deg, #8B5CF6, #7C3AED);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .btn-save-tarifa:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(80, 40, 167, 0.3);
    }
    
    .btn-save-tarifa:disabled {
      background: #7C3AED;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }
    
    .tarifa-info {
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(195, 54, 54, 0.1);
      border-radius: 6px;
      border-left: 4px solid #8B5CF6;
    }
    
    .tarifa-info small {
      color: #495057;
      font-size: 13px;
    }
    
    .tarifa-info strong {
      color: #7C3AED;
      font-weight: 600;
    }
    
    /* Controles personalizados */
    .custom-date-controls {
      width: 100%;
      margin-top: 15px;
      padding: 20px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 12px;
      border: 2px solid rgba(139, 92, 246, 0.1);
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .date-range {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .date-range label {
      font-size: 14px;
      font-weight: 600;
      color: #495057;
      white-space: nowrap;
    }
    
    .date-input {
      padding: 10px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      background: white;
      color: #495057;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }
    
    .date-input:focus {
      border-color: #8B5CF6;
      outline: none;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .btn-apply-dates {
      padding: 10px 20px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      white-space: nowrap;
    }
    
    .btn-apply-dates:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(251,191,36,0.4);
    }
    
    .btn-apply-dates:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }
    
    /* Controls */
    .controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .sector-selector {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .sector-selector label {
      font-size: 16px;
      font-weight: 600;
      color: #495057;
    }
    
    .sector-select {
      padding: 12px 24px;
      border: 2px solid #efeee9;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      background: white;
      color: #495057;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .sector-select:focus {
      border-color: #F59E0B;
      outline: none;
      box-shadow: 0 0 0 3px rgba(195,54,54,0.1);
    }
    
    .period-controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      flex: 1;
      justify-content: flex-end;
    }
    
    .period-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      color: #495057;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .period-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .period-btn.active {
      background: linear-gradient(135deg, #8B5CF6, #7C3AED);
      color: white;
    }
    
    /* Metrics Dashboard */
    .metrics-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .metric-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 20px;
      color: white;
      text-align: center;
      box-shadow: 0 5px 20px rgba(139, 92, 246, 0.3);
      transition: all 0.3s ease;
    }
    
    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
    }
    
    .metric-card.consumption {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .metric-card.cost {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .metric-card.efficiency {
      background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
    }
    
    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .metric-label {
      font-size: 0.9rem;
      opacity: 0.9;
      font-weight: 500;
    }
    
    .metric-trend {
      font-size: 0.8rem;
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    /* Charts */
    .charts-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    /* Desktop: gráficos lado a lado */
    @media (min-width: 768px) {
      .charts-container {
        grid-template-columns: 2fr 1fr;
        gap: 25px;
      }
    }
    
    .chart-card {
      background: white;
      border-radius: 16px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .chart-container {
      position: relative;
      height: 350px;
    }
    
    /* Table */
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    
    .consumption-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .consumption-table th {
      background: linear-gradient(135deg, #8B5CF6, #7C3AED);
      color: white;
      padding: 15px 12px;
      font-weight: 600;
      text-align: left;
      position: sticky;
      top: 0;
    }
    
    .consumption-table td {
      padding: 12px;
      border-bottom: 1px solid #f8f9fa;
      vertical-align: middle;
    }
    
    .consumption-table tr:hover {
      background: rgba(139, 92, 246, 0.05);
    }
    
    .consumption-table tr.no-data td {
      text-align: center;
      padding: 30px;
      color: #6c757d;
      font-style: italic;
    }
    
    /* Action Buttons */
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-decoration: none;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #c33636, #e74c3c);
      color: white;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #8B5CF6, #7C3AED);
      color: white;
    }
    
    .btn-conf {
      background: linear-gradient(135deg, #706d67, #b3afa7);
      color: white;
    }
    
    .last-update {
      text-align: center;
      color: #6c757d;
      font-size: 12px;
      margin-top: 15px;
      padding: 8px;
      background: rgba(108, 117, 125, 0.1);
      border-radius: 6px;
    }
    
    .data-info {
      text-align: center;
      margin: 20px 0;
      padding: 15px;
      background: rgba(51, 122, 183, 0.1);
      border-radius: 8px;
      border-left: 4px solid #337ab7;
    }
    
    .data-info h3 {
      margin: 0 0 10px 0;
      color: #337ab7;
      font-size: 16px;
    }
    
    .data-info p {
      margin: 5px 0;
      color: #495057;
      font-size: 14px;
    }
    
    /* Loading */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsividade apenas para MOBILE */
    @media (max-width: 767px) {
      body {
        overflow-x: hidden;
      }
      
      * {
        max-width: 100%;
      }
      
      .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
      }
      
      .toast {
        min-width: auto;
        max-width: none;
        font-size: 12px;
        padding: 12px 16px;
      }

      header {
        padding: 10px 15px;
        gap: 15px;
        flex-direction: column;
      }
      
      /* Reorganizar para mobile: logos primeiro */
      .header-left, .header-right {
        width: auto;
        flex: none;
      }
      
      .header-left {
        order: 1;
        align-self: flex-start;
      }
      
      .header-right {
        order: 2;
        align-self: flex-end;
        position: absolute;
        top: 10px;
        right: 15px;
      }
      
      .header-nav-section {
        display: none; /* Ocultar menu no mobile */
      }
      
      .header-logo-right {
        display: flex;
      }
      
      .header-center {
        order: 3;
        margin-bottom: 0;
        margin-left: 0;
        margin-top: 10px;
        text-align: center;
        width: 100%;
      }
      
      .header-title-section {
        flex-direction: column;
        gap: 8px;
        justify-content: center;
        align-items: center;
      }
      
      .header-title {
        font-size: 16px;
        text-align: center;
        order: 1;
      }
      
      .header-subtitle {
        font-size: 11px;
        text-align: center;
        order: 2;
      }
      
      .status-conexao {
        order: 3;
        font-size: 10px;
        padding: 3px 6px;
        margin-top: 5px;
      }

      header nav {
        display: none; /* Ocultar menu de navegação no mobile */
      }

      .logo {
        height: 32px;
      }

      main {
        padding: 15px;
      }

      .card {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 12px;
      }
      
      .charts-container {
        grid-template-columns: 1fr !important;
        gap: 15px;
      }
      
      .chart-card {
        width: 100%;
        max-width: 100%;
        padding: 12px;
      }
      
      .chart-container {
        height: 180px !important;
        max-height: 180px;
        width: 100%;
        overflow: hidden;
      }
      
      .chart-container canvas {
        max-width: 100% !important;
        height: 180px !important;
      }
      
      .metrics-dashboard {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .controls-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .sector-selector {
        flex-direction: column;
        gap: 8px;
      }
      
      .sector-select {
        width: 100%;
      }
      
      .period-controls {
        justify-content: center;
      }
      
      .date-range {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .date-input {
        width: 100%;
      }
      
      .btn-apply-dates {
        align-self: center;
        width: auto;
      }
      
      .metric-value {
        font-size: 2rem;
      }
    }
    
    @media (max-width: 480px) {
      .metrics-dashboard {
        grid-template-columns: 1fr;
      }
      
      .custom-date-controls {
        padding: 15px;
      }
      
      .chart-container {
        height: 160px !important;
        max-height: 160px;
        overflow: hidden;
      }
      
      .chart-container canvas {
        max-width: 100% !important;
        height: 160px !important;
      }
      
      .chart-card {
        padding: 10px;
        overflow: hidden;
      }
      
      .chart-title {
        font-size: 13px;
        margin-bottom: 6px;
      }
      
      .metric-value {
        font-size: 1.5rem;
      }
      
      .metric-card {
        padding: 10px;
      }
      
      .metric-label {
        font-size: 0.7rem;
      }
      
      .metric-trend {
        font-size: 0.6rem;
        margin-top: 4px;
      }
      
      main {
        padding: 10px;
      }
      
      .card {
        padding: 12px;
        margin-bottom: 12px;
      }
    }

    /* Animações */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .card {
      animation: fadeInUp 0.6s ease forwards;
    }

  </style>
</head>
<body>
  <!-- Container das notificações (sempre presente) -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Menus e Logos-->   
  <header>
    <div class="header-left">
      <a href="/"><img src="images/Viza_Logo.png" alt="Viza" class="logo"></a>
    </div>
    
    <div class="header-center">
      <div class="header-title-section">
        <h1 class="header-title">Sistema De Iluminação Viza</h1>
        <!-- Status da conexão -->
        <div id="status-conexao" class="status-conexao status-connecting">
          <span id="status-text">Conectando</span>
        </div>
      </div>
      <p class="header-subtitle">Controle Inteligente De Iluminação</p>
    </div>
    
    <div class="header-right">
      <div class="header-nav-section">
        <nav>
          <a href="/">🏢 Operação</a>
          <a href="/Visualizacao">📊 Visualização</a>
          <a href="/Consumo">⚡ Consumo</a>
          <a href="/Banco">🗄️ Banco</a>
          <a href="/Manual">📖 Manual</a>
        </nav>
      </div>
      
      <div class="header-logo-right">
        <img src="images/Engemase_Logo.png" alt="Engemase" class="logo">
      </div>
    </div>
  </header>
  
  <main>
    <!-- Configurações -->
    <div class="card">
      <h2>⚡ Monitoramento de Consumo Energético</h2>
      
      <!-- Configuração de Tarifa -->
      <div class="tarifa-config">
        <div class="tarifa-group">
          <label for="tarifaInput">💰 Tarifa de Energia (R$/kWh):</label>
          <div class="tarifa-input-group">
            <span class="currency-symbol">R$</span>
            <input type="number" 
                   id="tarifaInput" 
                   class="tarifa-input" 
                   step="0.01" 
                   min="0" 
                   max="5" 
                   placeholder="0.50">
            <button class="btn-save-tarifa" id="btnSalvarTarifa">
              <span>💾</span> Salvar
            </button>
          </div>
          <div class="tarifa-info">
            <small>💡 Valor atual: <strong id="tarifaAtual">R$ 0.50/kWh</strong></small>
          </div>
        </div>
      </div>

      <!-- Controles de Visualização -->
      <div class="controls-row">
        <div class="sector-selector">
          <label for="setorSelect">🏢 Filtrar por Setor:</label>
          <select id="setorSelect" class="sector-select">
            <option value="geral">🏢 Geral (Todos)</option>
            <option value="estacionamento">🚗 Estacionamento</option>
            <option value="loja">🏪 Loja</option>
            <option value="deposito">📦 Depósito</option>
          </select>
        </div>

        <div class="period-controls">
          <button class="period-btn active" data-periodo="hoje">📅 Hoje</button>
          <button class="period-btn" data-periodo="semana">📊 Semana</button>
          <button class="period-btn" data-periodo="mes">📈 Mês</button>
          <button class="period-btn" data-periodo="personalizado">📋 Período</button>
        </div>
      </div>
      
      <div class="custom-date-controls" id="customDateControls" style="display: none;">
        <div class="date-range">
          <label for="dataInicio">De:</label>
          <input type="date" id="dataInicio" class="date-input">
          <label for="dataFim">Até:</label>
          <input type="date" id="dataFim" class="date-input">
          <button class="btn-apply-dates" id="btnAplicarDatas">✓ Aplicar</button>
        </div>
      </div>
    </div>

    <!-- Métricas -->
    <div class="card">
      <div class="metrics-dashboard">
        <div class="metric-card consumption">
          <div class="metric-value" id="consumoTotal">--</div>
          <div class="metric-label">💡 kWh Total</div>
          <div class="metric-trend" id="tendenciaConsumo">
            <span>📊 Aguardando dados</span>
          </div>
        </div>
        
        <div class="metric-card cost">
          <div class="metric-value" id="custoTotal">R$ --</div>
          <div class="metric-label">💰 Custo Total</div>
          <div class="metric-trend" id="tendenciaCusto">
            <span>📊 Aguardando dados</span>
          </div>
        </div>
        
        <div class="metric-card efficiency">
          <div class="metric-value" id="eficienciaMedia">--%</div>
          <div class="metric-label">⚡ Eficiência Média</div>
          <div class="metric-trend" id="tendenciaEficiencia">
            <span>📊 Aguardando dados</span>
          </div>
        </div>
        
        <div class="metric-card">
          <div class="metric-value" id="totalRegistros">0</div>
          <div class="metric-label">📝 Registros</div>
          <div class="metric-trend" id="ultimoRegistro">
            <span>🕐 Sem dados</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="card">
      <h2>📊 Análise de Consumo</h2>
      
      <div class="charts-container">
        <div class="chart-card">
          <div class="chart-title">📈 Consumo por Horário</div>
          <div class="chart-container">
            <canvas id="consumoChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <div class="chart-title">🥧 Distribuição por Setor</div>
          <div class="chart-container">
            <canvas id="setorChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela de Registros -->
    <div class="card">
      <h2>📋 Registros de Consumo</h2>
      
      <div class="data-info">
        <h3>ℹ️ Dados do Banco</h3>
        <p><strong>Fonte:</strong> Registros salvos no banco de dados</p>
        <p><strong>Atualização:</strong> Automática a cada 1 hora após o banco rodar</p>
      </div>
      
      <div class="table-container">
        <table class="consumption-table" id="tabelaConsumo">
          <thead>
            <tr>
              <th>📅 Data/Horário</th>
              <th>🏢 Setor</th>
              <th>💡 Luminárias</th>
              <th>⚡ Consumo (kWh)</th>
              <th>💰 Custo (R$)</th>
              <th>☀️ Brilho Médio</th>
              <th>📊 Eficiência (%)</th>
            </tr>
          </thead>
          <tbody>
            <tr class="no-data">
              <td colspan="7">Carregando dados do banco...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="action-buttons">
        <button class="btn btn-success" id="btnExportar">
          📤 Exportar Excel
        </button>
        <button class="btn btn-primary" id="btnAtualizar">
          🔄 Atualizar Dados
        </button>
      </div>

      <div class="last-update">
        ⏰ Última atualização: <span id="ultimaAtualizacao">--:--:--</span>
      </div>
    </div>
  </main>

  <!-- Menu Inferior Estilo App -->
  <nav class="bottom-nav">
    <div class="nav-container">
      <a href="/" class="nav-item">
        <div class="nav-icon">🏢</div>
        <div class="nav-label">Operação</div>
      </a>
      <a href="/Visualizacao" class="nav-item">
        <div class="nav-icon">📊</div>
        <div class="nav-label">Visualização</div>
      </a>
      <a href="/Consumo" class="nav-item active">
        <div class="nav-icon">⚡</div>
        <div class="nav-label">Consumo</div>
      </a>
      <a href="/Banco" class="nav-item">
        <div class="nav-icon">🗄️</div>
        <div class="nav-label">Banco</div>
      </a>
      <a href="/Manual" class="nav-item">
        <div class="nav-icon">📖</div>
        <div class="nav-label">Manual</div>
      </a>
    </div>
  </nav>

  <script>
    // ========== SISTEMA DE NOTIFICAÇÕES TOAST ==========
    
    class ToastManager {
      constructor() {
        this.container = document.getElementById('toast-container');
        this.toasts = new Map();
        this.toastCounter = 0;
      }

      show(type, title, message, options = {}) {
        const id = ++this.toastCounter;
        const toast = this.createToast(id, type, title, message, options);
        
        this.container.appendChild(toast);
        this.toasts.set(id, toast);

        // Trigger animation
        setTimeout(() => toast.classList.add('show'), 10);

        // Auto remove (unless persistent)
        if (!options.persistent) {
          const duration = options.duration || 5000;
          setTimeout(() => this.remove(id), duration);
        }

        return id;
      }

      createToast(id, type, title, message, options) {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.dataset.id = id;

        const iconMap = {
          success: '✓',
          error: '✕',
          warning: '⚠',
          info: 'ℹ',
          system: '⚙'
        };

        toast.innerHTML = `
          <div class="toast-icon">${iconMap[type] || 'ℹ'}</div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" onclick="toast.remove(${id})">&times;</button>
          <div class="toast-progress"></div>
        `;

        return toast;
      }

      remove(id) {
        const toast = this.toasts.get(id);
        if (toast) {
          toast.classList.add('hide');
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
            this.toasts.delete(id);
          }, 400);
        }
      }

      success(title, message, options = {}) {
        return this.show('success', title, message, options);
      }

      error(title, message, options = {}) {
        return this.show('error', title, message, options);
      }

      warning(title, message, options = {}) {
        return this.show('warning', title, message, options);
      }

      info(title, message, options = {}) {
        return this.show('info', title, message, options);
      }

      system(title, message, options = {}) {
        return this.show('system', title, message, options);
      }
    }

    // Instância global do toast
    const toast = new ToastManager();

    // ========== GERENCIADOR DE DADOS ==========
    class DataManager {
      constructor() {
        this.dados = [];
        this.tarifaAtual = 0.50;
        this.setorAtual = 'geral';
        this.periodoAtual = 'hoje';
        this.carregando = false;
        this.dataInicio = null;
        this.dataFim = null;
      }

      definirPeriodoPersonalizado(dataInicio, dataFim) {
        this.dataInicio = new Date(dataInicio);
        this.dataFim = new Date(dataFim);
        this.dataFim.setHours(23, 59, 59, 999);
        this.periodoAtual = 'personalizado';
      }

      async carregarDadosBanco() {
        if (this.carregando) return;
        this.carregando = true;

        try {
          const params = new URLSearchParams({
            setor: this.setorAtual,
            limit: '100',
            ordem: 'desc'
          });

          const baseUrls = [
            'http://192.168.4.2:5000',
          ];

          let response;
          let urlUsada;
          
          for (const baseUrl of baseUrls) {
            const url = baseUrl ? `${baseUrl}/api/consumo/registros?${params}` : `/api/consumo/registros?${params}`;
            console.log('Tentando carregar de:', url);
            
            try {
              response = await fetch(url, {
                method: 'GET',
                headers: {
                  'Accept': 'application/json',
                  'Cache-Control': 'no-cache'
                },
                mode: 'cors'
              });
              
              if (response.ok || response.status === 404) {
                urlUsada = url;
                break;
              }
            } catch (fetchError) {
              console.log(`Falha ao conectar em ${url}:`, fetchError.message);
              continue;
            }
          }

          if (!response) {
            throw new Error('Não foi possível conectar ao servidor de banco de dados');
          }

          console.log('Conectado em:', urlUsada);
          console.log('Status da resposta:', response.status);

          const contentType = response.headers.get('content-type');
          
          if (!contentType || !contentType.includes('application/json')) {
            console.warn('Resposta não é JSON. Content-Type:', contentType);
            const text = await response.text();
            console.error('Resposta recebida (não JSON):', text.substring(0, 200));
            throw new Error('Servidor não retornou JSON. Verifique se o servidor Python está rodando.');
          }

          const data = await response.json();
          console.log('Dados recebidos:', data);
          
          if (data.status === 'success' && Array.isArray(data.registros)) {
            this.dados = data.registros.map(r => {
              let timestamp;
              let horarioCompleto;
              
              if (r.timestamp) {
                timestamp = new Date(r.timestamp).getTime();
                const dataObj = new Date(r.timestamp);
                horarioCompleto = dataObj.toLocaleString('pt-BR', {
                  day: '2-digit',
                  month: '2-digit', 
                  year: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });
              } else {
                timestamp = Date.now();
                horarioCompleto = '--/--/---- --:--';
              }

              return {
                id: r.id,
                horario: horarioCompleto,
                setor: r.setor,
                consumo: parseFloat(r.consumo_real || 0),
                custo: parseFloat(r.custo_real || 0),
                brilho_medio: parseInt(r.brilho_medio || 0),
                eficiencia: parseFloat(r.eficiencia || 0),
                luminarias: parseInt(r.luminarias_ativas || 0),
                timestamp: timestamp
              };
            });
            
            console.log('Dados processados:', this.dados.length, 'registros');
            return this.dados;
          } else if (data.status === 'error') {
            console.error('Erro retornado pelo servidor:', data.message);
            this.dados = [];
            return [];
          }
          
          console.warn('Formato de resposta inesperado:', data);
          this.dados = [];
          return [];
          
        } catch (error) {
          console.error('Erro ao carregar dados do banco:', error);
          
          if (error.message.includes('Failed to fetch')) {
            console.error('Erro de conexão: Verifique se o servidor Python está rodando na porta 5000');
          } else if (error.message.includes('JSON')) {
            console.error('Erro de formato: O servidor não está retornando JSON válido');
          }
          
          this.dados = [];
          throw error;
        } finally {
          this.carregando = false;
        }
      }

      async carregarTarifa() {
        try {
          const baseUrls = [
            'http://192.168.4.2:5000',
          ];

          for (const baseUrl of baseUrls) {
            const url = baseUrl ? `${baseUrl}/api/tarifa_energia` : '/api/tarifa_energia';
            
            try { 
              const response = await fetch(url, {
                method: 'GET',
                headers: {
                  'Accept': 'application/json'
                },
                mode: 'cors'
              });
              
              if (response.ok) {
                const data = await response.json();
                this.tarifaAtual = data.tarifa || 0.50;
                console.log('Tarifa carregada:', this.tarifaAtual);
                return this.tarifaAtual;
              }
            } catch (error) {
              continue;
            }
          }
          
          console.warn('Não foi possível carregar tarifa, usando padrão');
          return 0.50;
        } catch (error) {
          console.error('Erro ao carregar tarifa:', error);
          return 0.50;
        }
      }

      async salvarTarifa(valor) {
        try {
          const url = '/api/tarifa_energia';
          
          const response = await fetch(url, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ tarifa: valor })
          });
          
          if (response.ok) {
            console.log('✅ Tarifa salva no servidor:', valor);
            this.tarifaAtual = valor;
            this.dados.forEach(d => {
              d.custo = d.consumo * valor;
            });
            return true;
          } else {
            console.error('❌ Erro ao salvar tarifa:', response.status, response.statusText);
            return false;
          }
        } catch (error) {
          console.error('❌ Erro na requisição:', error);
          return false;
        }
      }

      filtrarPorPeriodo(dados) {
        const agora = new Date();
        
        return dados.filter(d => {
          const dataRegistro = new Date(d.timestamp);
          
          switch(this.periodoAtual) {
            case 'hoje':
              return dataRegistro.toDateString() === agora.toDateString();
            case 'semana':
              const inicioSemana = new Date(agora);
              inicioSemana.setDate(agora.getDate() - agora.getDay());
              inicioSemana.setHours(0, 0, 0, 0);
              return dataRegistro >= inicioSemana;
            case 'mes':
              return dataRegistro.getMonth() === agora.getMonth() && 
                     dataRegistro.getFullYear() === agora.getFullYear();
            case 'personalizado':
              if (!this.dataInicio || !this.dataFim) return false;
              return dataRegistro >= this.dataInicio && dataRegistro <= this.dataFim;
            default:
              return true;
          }
        });
      }

      calcularMetricas() {
        const dadosFiltrados = this.filtrarPorPeriodo(this.dados);
        
        const totalConsumo = dadosFiltrados.reduce((sum, d) => sum + d.consumo, 0);
        const totalCusto = dadosFiltrados.reduce((sum, d) => sum + d.custo, 0);
        
        const eficiencias = dadosFiltrados.map(d => d.eficiencia).filter(e => e > 0);
        const mediaEficiencia = eficiencias.length > 0 ? 
          eficiencias.reduce((a, b) => a + b) / eficiencias.length : 0;
        
        return {
          totalConsumo,
          totalCusto,
          mediaEficiencia,
          totalRegistros: dadosFiltrados.length,
          dadosFiltrados
        };
      }
    }

    // Variáveis para controle de status de conexão
    let statusConexao = false;
    let toastConexaoId = null;
    let verificandoConexao = false;
    let tentativasFalhas = 0;

    // ========== FUNÇÕES DE STATUS DE CONEXÃO ==========

    // Função Para Verificar Conexão Com a Rede WiFi Específica
    async function verificarConexaoViza() {
      // Se já sabemos que não há internet, não adianta tentar
      if (!navigator.onLine) {
        return false;
      }

      try {
        // Verificar se é possível acessar o sistema Viza
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 4000); // Aumentado para 4 segundos

        const response = await fetch('/estado', {
          method: 'GET',
          signal: controller.signal,
          cache: 'no-cache'
        });
        clearTimeout(timeoutId);

        if (response.ok) {
          tentativasFalhas = 0; // Resetar contador em caso de sucesso
          return true;
        } else {
          tentativasFalhas++;
          return false;
        }
      } catch (error) {
        tentativasFalhas++;
        console.log(`Erro na verificação de conexão (tentativa ${tentativasFalhas}):`, error.name);
        // Só retorna 'false' de fato após 3 tentativas
        if (tentativasFalhas < 6) {
          return true; // Finge que está online para ser mais tolerante
        }
        console.log('Erro na verificação de conexão:', error.name);
        return false;
      }
    }

    // Função Para Atualizar Status da Conexão
    async function atualizarStatusConexao() {
      if (verificandoConexao) return;
      verificandoConexao = true;

      try {
        const conectadoViza = await verificarConexaoViza();
        const statusElement = document.getElementById('status-conexao');
        const statusText = document.getElementById('status-text');
        
        if (statusElement) {
          if (conectadoViza && !statusConexao) {
            // Conectou à rede Viza
            statusText.textContent = 'Conectado';
            statusElement.className = 'status-conexao status-online';
            
            // Remover toast de conexão perdida se existir
            if (toastConexaoId) {
              toast.remove(toastConexaoId);
              toastConexaoId = null;
            }
            
            toast.success('Conectado à rede Iluminação_Viza', 'Sistema de iluminação disponível');

          } else if (!conectadoViza && statusConexao) {
            // Perdeu conexão com a rede Viza
            statusText.textContent = 'Desconectado';
            statusElement.className = 'status-conexao status-offline';
            
            toastConexaoId = toast.error('Fora da rede Iluminação_Viza', 'Conecte-se à rede WiFi "Iluminação_Viza" para controlar o sistema', {
              persistent: true,
              action: {
                text: 'Tentar Novamente',
                callback: () => {
                  atualizarStatusConexao();
                  toast.info('Verificando...', 'Tentando conectar à rede Iluminação_Viza');
                }
              }
            });
          }
          
          statusConexao = conectadoViza;
        }
      } catch (error) {
        console.error('Erro ao verificar status:', error);
      } finally {
        verificandoConexao = false;
      }
    }

    // Atualização de status em tempo real
    function atualizarStatusTempoReal() {
      // Verificar status da conexão com a rede Viza a cada 2 segundos
      setInterval(atualizarStatusConexao, 2000);
    }

    // Monitoramento de rede aprimorado
    function monitorarConexao() {
      // Verificar mudanças na conectividade geral
      window.addEventListener('online', () => {
        setTimeout(atualizarStatusConexao, 1000); // Aguardar 1 segundo e verificar
      });
      
      window.addEventListener('offline', () => {
        if (statusConexao) {
          const statusElement = document.getElementById('status-conexao');
          const statusText = document.getElementById('status-text');
          
          statusText.textContent = 'Desconectado';
          statusElement.className = 'status-conexao status-offline';
          
          toast.warning('Sem Conexão com Internet', 'Verifique sua conectividade', {
            persistent: true
          });
          
          statusConexao = false;
        }
      });

      // Verificar quando a página ganha foco (usuário volta ao app)
      window.addEventListener('focus', () => {
        setTimeout(atualizarStatusConexao, 500);
      });

      // Verificar quando há mudança de visibilidade da página
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          setTimeout(atualizarStatusConexao, 500);
        }
      });
    }

    // ========== GERENCIADOR DE INTERFACE ==========
    class UIManager {
      constructor(dataManager, toast) {
        this.dataManager = dataManager;
        this.toast = toast;
        this.consumoChart = null;
        this.setorChart = null;
      }

      inicializar() {
        this.configurarEventListeners();
        this.inicializarGraficos();
        this.carregarDadosIniciais();
        this.iniciarAtualizacaoAutomatica();
      }

      configurarEventListeners() {
        document.getElementById('btnSalvarTarifa').addEventListener('click', () => this.salvarTarifa());
        
        document.getElementById('setorSelect').addEventListener('change', (e) => {
          this.dataManager.setorAtual = e.target.value;
          this.atualizarDados();
        });
        
        document.querySelectorAll('.period-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            const periodo = e.target.dataset.periodo;
            this.dataManager.periodoAtual = periodo;
            
            const customControls = document.getElementById('customDateControls');
            if (periodo === 'personalizado') {
              customControls.style.display = 'block';
              this.configurarDatasIniciais();
            } else {
              customControls.style.display = 'none';
              this.atualizarInterface();
            }
          });
        });
        
        document.getElementById('btnAplicarDatas').addEventListener('click', () => this.aplicarDatasPersonalizadas());
        document.getElementById('dataInicio').addEventListener('change', () => this.validarDatas());
        document.getElementById('dataFim').addEventListener('change', () => this.validarDatas());
        document.getElementById('btnAtualizar').addEventListener('click', () => this.atualizarDados());
        document.getElementById('btnExportar').addEventListener('click', () => this.exportarExcel());
      }

      configurarDatasIniciais() {
        const hoje = new Date();
        const semanaAtras = new Date();
        semanaAtras.setDate(hoje.getDate() - 7);
        
        const formatarData = (data) => {
          return data.getFullYear() + '-' + 
                 String(data.getMonth() + 1).padStart(2, '0') + '-' + 
                 String(data.getDate()).padStart(2, '0');
        };
        
        document.getElementById('dataInicio').value = formatarData(semanaAtras);
        document.getElementById('dataFim').value = formatarData(hoje);
        document.getElementById('dataFim').max = formatarData(hoje);
        document.getElementById('dataInicio').max = formatarData(hoje);
        
        this.validarDatas();
      }

      validarDatas() {
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const btnAplicar = document.getElementById('btnAplicarDatas');
        
        if (!dataInicio || !dataFim) {
          btnAplicar.disabled = true;
          btnAplicar.textContent = '✓ Selecione as datas';
          return false;
        }
        
        const inicio = new Date(dataInicio);
        const fim = new Date(dataFim);
        
        if (inicio > fim) {
          btnAplicar.disabled = true;
          btnAplicar.textContent = '⚠ Data inválida';
          btnAplicar.style.background = '#ef4444';
          return false;
        }
        
        const diffDias = Math.ceil((fim - inicio) / (1000 * 60 * 60 * 24));
        if (diffDias > 90) {
          btnAplicar.disabled = true;
          btnAplicar.textContent = '⚠ Máximo 90 dias';
          btnAplicar.style.background = '#f59e0b';
          return false;
        }
        
        btnAplicar.disabled = false;
        btnAplicar.textContent = '✓ Aplicar';
        btnAplicar.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        return true;
      }

      aplicarDatasPersonalizadas() {
        if (!this.validarDatas()) return;
        
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        
        this.dataManager.definirPeriodoPersonalizado(dataInicio, dataFim);
        
        const inicio = new Date(dataInicio);
        const fim = new Date(dataFim);
        const formatoExibicao = { day: '2-digit', month: '2-digit', year: 'numeric' };
        
        this.toast.info(
          'Período Aplicado',
          `${inicio.toLocaleDateString('pt-BR', formatoExibicao)} até ${fim.toLocaleDateString('pt-BR', formatoExibicao)}`
        );
        
        this.atualizarInterface();
      }

      async carregarDadosIniciais() {
        try {
          const tarifa = await this.dataManager.carregarTarifa();
          document.getElementById('tarifaInput').value = tarifa.toFixed(2);
          document.getElementById('tarifaAtual').textContent = `R$ ${tarifa.toFixed(2)}/kWh`;
          
          await this.atualizarDados();
        } catch (error) {
          console.error('Erro ao carregar dados iniciais:', error);
          this.toast.error('Erro', 'Falha ao carregar dados iniciais');
        }
      }

      async atualizarDados() {
        try {
          this.mostrarCarregando(true);
          
          await this.dataManager.carregarDadosBanco();
          
          if (this.dataManager.dados.length > 0) {
            this.toast.success('Dados Carregados', `${this.dataManager.dados.length} registros encontrados`);
          } else {
            this.toast.info('Sem Dados', 'Nenhum registro encontrado no banco');
          }
          
          this.atualizarInterface();
        } catch (error) {
          this.toast.error('Erro de Conexão', 'Falha ao carregar dados do banco');
        } finally {
          this.mostrarCarregando(false);
        }
      }

      atualizarInterface() {
        const metricas = this.dataManager.calcularMetricas();
        const isSetorEspecifico = this.dataManager.setorAtual !== 'geral';
        
        if (isSetorEspecifico) {
          const dadosSetor = metricas.dadosFiltrados.filter(d => d.setor === this.dataManager.setorAtual);
          const consumoSetor = dadosSetor.reduce((sum, d) => sum + d.consumo, 0);
          const custoSetor = dadosSetor.reduce((sum, d) => sum + d.custo, 0);
          const eficienciasSetor = dadosSetor.map(d => d.eficiencia).filter(e => e > 0);
          const mediaEficienciaSetor = eficienciasSetor.length > 0 ? 
            eficienciasSetor.reduce((a, b) => a + b) / eficienciasSetor.length : 0;
          const maxLuminariaSetor = dadosSetor.reduce((max, d) => Math.max(max, d.luminarias), 0);
          
          document.getElementById('consumoTotal').textContent = consumoSetor.toFixed(3);
          document.getElementById('custoTotal').textContent = `R$ ${custoSetor.toFixed(2)}`;
          document.getElementById('eficienciaMedia').textContent = `${Math.round(mediaEficienciaSetor)}%`;
          document.getElementById('totalRegistros').textContent = maxLuminariaSetor;
        } else {
          document.getElementById('consumoTotal').textContent = metricas.totalConsumo.toFixed(3);
          document.getElementById('custoTotal').textContent = `R$ ${metricas.totalCusto.toFixed(2)}`;
          document.getElementById('eficienciaMedia').textContent = `${Math.round(metricas.mediaEficiencia)}%`;
          document.getElementById('totalRegistros').textContent = metricas.totalRegistros;
        }
        
        this.atualizarTabela(metricas.dadosFiltrados);
        this.atualizarGraficos(metricas.dadosFiltrados);
        
        const agora = new Date();
        document.getElementById('ultimaAtualizacao').textContent = agora.toLocaleTimeString('pt-BR');
      }

      atualizarGraficos(dados) {
        if (!this.consumoChart || !this.setorChart) return;

        if (this.dataManager.setorAtual === 'geral') {
          const setoresParaExibir = ['estacionamento', 'loja', 'deposito'];
          const coresSetores = {
            'estacionamento': '#3B82F6',
            'loja': '#10B981',
            'deposito': '#F59E0B'
          };
          
          const dadosPorSetor = {};
          const todosHorarios = new Set();
          
          setoresParaExibir.forEach(setor => {
            dadosPorSetor[setor] = {};
          });
          
          const dadosFiltrados = dados.filter(d => setoresParaExibir.includes(d.setor));
          
          dadosFiltrados.forEach(d => {
            const horario = d.horario.includes(' ') ? d.horario.split(' ')[1] : d.horario;
            todosHorarios.add(horario);
            
            if (!dadosPorSetor[d.setor][horario]) {
              dadosPorSetor[d.setor][horario] = 0;
            }
            dadosPorSetor[d.setor][horario] += d.consumo;
          });
          
          const horariosOrdenados = Array.from(todosHorarios).sort();
          
          const datasets = setoresParaExibir.map(setor => {
            const setorNomes = {
              'estacionamento': 'Estacionamento',
              'loja': 'Loja',
              'deposito': 'Depósito'
            };
            
            return {
              label: setorNomes[setor],
              data: horariosOrdenados.map(horario => dadosPorSetor[setor][horario] || 0),
              borderColor: coresSetores[setor],
              backgroundColor: coresSetores[setor] + '20',
              borderWidth: 2,
              tension: 0.3,
              fill: false,
              pointRadius: 4,
              pointHoverRadius: 6
            };
          });
          
          this.consumoChart.data.labels = horariosOrdenados;
          this.consumoChart.data.datasets = datasets;
          this.consumoChart.options.plugins.legend.display = true;
        } else {
          const dadosSetor = dados.filter(d => d.setor === this.dataManager.setorAtual);
          const dadosOrdenados = [...dadosSetor].sort((a, b) => a.timestamp - b.timestamp).slice(-24);
          
          const labelsGrafico = dadosOrdenados.map(d => {
            if (d.horario.includes(' ')) {
              return d.horario.split(' ')[1];
            }
            return d.horario;
          });
          
          const coresSetores = {
            'estacionamento': '#3B82F6',
            'loja': '#10B981',
            'deposito': '#F59E0B'
          };
          
          this.consumoChart.data.labels = labelsGrafico;
          this.consumoChart.data.datasets = [{
            label: this.dataManager.setorAtual,
            data: dadosOrdenados.map(d => d.consumo),
            borderColor: coresSetores[this.dataManager.setorAtual] || '#8B5CF6',
            backgroundColor: (coresSetores[this.dataManager.setorAtual] || '#8B5CF6') + '20',
            borderWidth: 3,
            tension: 0.3,
            fill: false
          }];
          
          this.consumoChart.options.plugins.legend.display = false;
        }
        
        this.consumoChart.update();

        if (this.dataManager.setorAtual === 'geral') {
          const setoresParaPizza = ['estacionamento', 'loja', 'deposito'];
          const consumoPorSetor = {};
          
          dados.filter(d => setoresParaPizza.includes(d.setor)).forEach(d => {
            if (!consumoPorSetor[d.setor]) consumoPorSetor[d.setor] = 0;
            consumoPorSetor[d.setor] += d.consumo;
          });
          
          const total = Object.values(consumoPorSetor).reduce((a, b) => a + b, 0);
          
          if (total > 0) {
            const setorNomes = {
              'estacionamento': 'Estacionamento',
              'loja': 'Loja',
              'deposito': 'Depósito'
            };
            
            const coresPizza = ['#3B82F6', '#10B981', '#F59E0B'];
            
            this.setorChart.data.labels = Object.keys(consumoPorSetor).map(s => setorNomes[s]);
            this.setorChart.data.datasets[0].data = Object.values(consumoPorSetor).map(v => ((v/total) * 100).toFixed(1));
            this.setorChart.data.datasets[0].backgroundColor = coresPizza.slice(0, Object.keys(consumoPorSetor).length);
          } else {
            this.setorChart.data.labels = ['Sem dados'];
            this.setorChart.data.datasets[0].data = [100];
            this.setorChart.data.datasets[0].backgroundColor = ['#E5E7EB'];
          }
        } else {
          const setorNomes = {
            'estacionamento': 'Estacionamento',
            'loja': 'Loja',
            'deposito': 'Depósito'
          };
          
          const coresPorSetor = {
            'estacionamento': '#3B82F6',
            'loja': '#10B981',
            'deposito': '#F59E0B'
          };
          
          this.setorChart.data.labels = [setorNomes[this.dataManager.setorAtual] || this.dataManager.setorAtual];
          this.setorChart.data.datasets[0].data = [100];
          this.setorChart.data.datasets[0].backgroundColor = [coresPorSetor[this.dataManager.setorAtual] || '#8B5CF6'];
        }
        
        this.setorChart.update();
      }

      atualizarTabela(dados) {
        const tbody = document.querySelector('#tabelaConsumo tbody');
        tbody.innerHTML = '';
        
        if (dados.length === 0) {
          tbody.innerHTML = '<tr class="no-data"><td colspan="7">Nenhum registro encontrado</td></tr>';
          return;
        }
        
        const setorNomes = {
          'estacionamento': 'Estacionamento',
          'loja': 'Loja',
          'deposito': 'Depósito',
          'geral': 'Geral'
        };
        
        dados.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.horario}</td>
            <td>${setorNomes[d.setor] || d.setor}</td>
            <td>${d.luminarias}</td>
            <td>${d.consumo.toFixed(3)}</td>
            <td>R$ ${d.custo.toFixed(2)}</td>
            <td>${d.brilho_medio}</td>
            <td style="color: ${d.eficiencia >= 85 ? '#10b981' : d.eficiencia >= 70 ? '#f59e0b' : '#ef4444'}">
              ${d.eficiencia.toFixed(1)}%
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      inicializarGraficos() {
        if (typeof Chart === 'undefined') {
          console.error('Chart.js não carregado');
          setTimeout(() => this.inicializarGraficos(), 1000);
          return;
        }

        const ctxConsumo = document.getElementById('consumoChart').getContext('2d');
        const ctxSetor = document.getElementById('setorChart').getContext('2d');

        this.consumoChart = new Chart(ctxConsumo, {
          type: 'line',
          data: {
            labels: [],
            datasets: []
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: { beginAtZero: true },
              x: {}
            }
          }
        });

        this.setorChart = new Chart(ctxSetor, {
          type: 'doughnut',
          data: {
            labels: [],
            datasets: [{
              data: [],
              backgroundColor: ['#3B82F6', '#10B981', '#F59E0B'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            },
            cutout: '60%'
          }
        });
      }

      async salvarTarifa() {
        const input = document.getElementById('tarifaInput');
        const btn = document.getElementById('btnSalvarTarifa');
        const valor = parseFloat(input.value);
        
        if (isNaN(valor) || valor < 0 || valor > 5) {
          this.toast.warning('Valor Inválido', 'Use valores entre R$ 0,00 e R$ 5,00');
          return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Salvando...';
        
        const sucesso = await this.dataManager.salvarTarifa(valor);
        
        if (sucesso) {
          document.getElementById('tarifaAtual').textContent = `R$ ${valor.toFixed(2)}/kWh`;
          this.toast.success('Tarifa Salva', `Nova tarifa: R$ ${valor.toFixed(2)}/kWh`);
          this.atualizarInterface();
        } else {
          this.toast.error('Erro', 'Falha ao salvar tarifa');
        }
        
        btn.disabled = false;
        btn.innerHTML = '<span>💾</span> Salvar';
      }

      exportarExcel() {
        const metricas = this.dataManager.calcularMetricas();
        
        if (metricas.dadosFiltrados.length === 0) {
          this.toast.warning('Sem Dados', 'Nenhum dado para exportar');
          return;
        }
        
        let nomePeriodo = this.dataManager.periodoAtual;
        if (this.dataManager.periodoAtual === 'personalizado' && this.dataManager.dataInicio && this.dataManager.dataFim) {
          const inicio = this.dataManager.dataInicio.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
          const fim = this.dataManager.dataFim.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
          nomePeriodo = `${inicio}_a_${fim}`;
        }
        
        const ws_data = [
          ["Relatório de Consumo Energético"],
          [`Período: ${nomePeriodo}`],
          [""],
          ["Data/Horário", "Setor", "Luminárias", "Consumo (kWh)", "Custo (R$)", "Brilho Médio", "Eficiência (%)"]
        ];
        
        metricas.dadosFiltrados.forEach(d => {
          ws_data.push([
            d.horario,
            d.setor,
            d.luminarias,
            d.consumo.toFixed(3),
            d.custo.toFixed(2),
            d.brilho_medio,
            d.eficiencia.toFixed(1)
          ]);
        });
        
        ws_data.push([]);
        ws_data.push([
          "TOTAIS", "", "",
          metricas.totalConsumo.toFixed(3),
          metricas.totalCusto.toFixed(2),
          "",
          metricas.mediaEficiencia.toFixed(1)
        ]);
        
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Consumo");
        
        const nomeArquivo = `consumo_${this.dataManager.setorAtual}_${nomePeriodo}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, nomeArquivo);
        
        this.toast.success('Excel Exportado', `Arquivo: ${nomeArquivo}`);
      }

      mostrarCarregando(mostrar) {
        const tbody = document.querySelector('#tabelaConsumo tbody');
        if (mostrar) {
          tbody.innerHTML = '<tr class="no-data"><td colspan="7">Carregando dados do banco...</td></tr>';
        }
      }

      iniciarAtualizacaoAutomatica() {
        setInterval(() => {
          this.atualizarDados();
        }, 120000);
        
        setInterval(() => {
          const agora = new Date();
          document.getElementById('ultimaAtualizacao').textContent = agora.toLocaleTimeString('pt-BR');
        }, 1000);
      }
    }

    // ========== INICIALIZAÇÃO ==========
    
    document.addEventListener('DOMContentLoaded', function() {
      const dataManager = new DataManager();
      const uiManager = new UIManager(dataManager, toast);
      
      uiManager.inicializar();
      
      toast.info('Sistema Iniciado', 'Carregando dados do banco...');
    });

    // Inicializar monitoramento
    atualizarStatusTempoReal();
    monitorarConexao();
    
    // Verificar status inicial da conexão
    setTimeout(atualizarStatusConexao, 1000);

  </script>

</body>
</html>
